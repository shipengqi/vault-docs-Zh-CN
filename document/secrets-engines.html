<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Secrets 引擎 | Vault 中文文档</title>
    <meta name="description" content="欢迎来到 HashiCorp Vault 介绍指南!本指南是开始使用 Vault 的最佳地点。本指南涵盖了Vault 是什么，它可以解决什么问题，它如何与现有软件进行比较，
并包含了使用 Vault 的快速入门。">
    <link rel="icon" href="/vault-docs-Zh-CN/logo.png">
    
    <link rel="preload" href="/vault-docs-Zh-CN/assets/css/styles.341f2fd2.css" as="style"><link rel="preload" href="/vault-docs-Zh-CN/assets/js/app.341f2fd2.js" as="script"><link rel="preload" href="/vault-docs-Zh-CN/assets/js/14.92bdbbbe.js" as="script"><link rel="prefetch" href="/vault-docs-Zh-CN/assets/css/1.styles.03294af5.css"><link rel="prefetch" href="/vault-docs-Zh-CN/assets/css/3.styles.c23ef979.css"><link rel="prefetch" href="/vault-docs-Zh-CN/assets/js/1.03294af5.js"><link rel="prefetch" href="/vault-docs-Zh-CN/assets/js/10.06280d87.js"><link rel="prefetch" href="/vault-docs-Zh-CN/assets/js/11.bcdf7111.js"><link rel="prefetch" href="/vault-docs-Zh-CN/assets/js/12.237d0fc4.js"><link rel="prefetch" href="/vault-docs-Zh-CN/assets/js/13.68dc0d8d.js"><link rel="prefetch" href="/vault-docs-Zh-CN/assets/js/15.b2db5799.js"><link rel="prefetch" href="/vault-docs-Zh-CN/assets/js/16.686d05ff.js"><link rel="prefetch" href="/vault-docs-Zh-CN/assets/js/2.1eb2df92.js"><link rel="prefetch" href="/vault-docs-Zh-CN/assets/js/3.c23ef979.js"><link rel="prefetch" href="/vault-docs-Zh-CN/assets/js/4.4470f8cc.js"><link rel="prefetch" href="/vault-docs-Zh-CN/assets/js/5.072add43.js"><link rel="prefetch" href="/vault-docs-Zh-CN/assets/js/6.4dd90ff1.js"><link rel="prefetch" href="/vault-docs-Zh-CN/assets/js/7.4656fea3.js"><link rel="prefetch" href="/vault-docs-Zh-CN/assets/js/8.a0b92025.js"><link rel="prefetch" href="/vault-docs-Zh-CN/assets/js/9.0280e8d3.js">
    <link rel="stylesheet" href="/vault-docs-Zh-CN/assets/css/1.styles.03294af5.css"><link rel="stylesheet" href="/vault-docs-Zh-CN/assets/css/3.styles.c23ef979.css"><link rel="stylesheet" href="/vault-docs-Zh-CN/assets/css/styles.341f2fd2.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/vault-docs-Zh-CN/" class="home-link router-link-active"><!----> <span class="site-name">Vault 中文文档</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/vault-docs-Zh-CN/guide/" class="nav-link">入门指南</a></div><div class="nav-item"><a href="/vault-docs-Zh-CN/document/" class="nav-link router-link-active">文档</a></div><div class="nav-item"><a href="/vault-docs-Zh-CN/api/" class="nav-link">API</a></div> <a href="https://github.com/shipengqi/vault-docs-Zh-CN" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/vault-docs-Zh-CN/guide/" class="nav-link">入门指南</a></div><div class="nav-item"><a href="/vault-docs-Zh-CN/document/" class="nav-link router-link-active">文档</a></div><div class="nav-item"><a href="/vault-docs-Zh-CN/api/" class="nav-link">API</a></div> <a href="https://github.com/shipengqi/vault-docs-Zh-CN" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first collapsable"><p class="sidebar-heading open"><span>文档（持续更新中...）</span> <span class="arrow down"></span></p> <ul class="sidebar-group-items"><li><a href="/vault-docs-Zh-CN/document/" class="sidebar-link">Vault 文档</a></li><li><a href="/vault-docs-Zh-CN/document/installing.html" class="sidebar-link">安装</a></li><li><a href="/vault-docs-Zh-CN/document/internals.html" class="sidebar-link">内部构件</a></li><li><a href="/vault-docs-Zh-CN/document/concepts.html" class="sidebar-link">概念</a></li><li><a href="/vault-docs-Zh-CN/document/configuration.html" class="sidebar-link">配置</a></li><li><a href="/vault-docs-Zh-CN/document/cli.html" class="sidebar-link">CLI</a></li><li><a href="/vault-docs-Zh-CN/document/vault-agent.html" class="sidebar-link">Vault 代理</a></li><li><a href="/vault-docs-Zh-CN/document/secrets-engines.html" class="active sidebar-link">Secrets 引擎</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vault-docs-Zh-CN/document/secrets-engines.html#overview" class="sidebar-link">Overview</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vault-docs-Zh-CN/document/secrets-engines.html#secrets-engines-lifecycle" class="sidebar-link">Secrets Engines Lifecycle</a></li><li class="sidebar-sub-header"><a href="/vault-docs-Zh-CN/document/secrets-engines.html#barrier-view" class="sidebar-link">Barrier View</a></li></ul></li><li class="sidebar-sub-header"><a href="/vault-docs-Zh-CN/document/secrets-engines.html#kv-secrets-engine" class="sidebar-link">KV Secrets Engine</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vault-docs-Zh-CN/document/secrets-engines.html#overview-2" class="sidebar-link">Overview</a></li><li class="sidebar-sub-header"><a href="/vault-docs-Zh-CN/document/secrets-engines.html#kv-secrets-engine-version-1" class="sidebar-link">KV Secrets Engine - Version 1</a></li><li class="sidebar-sub-header"><a href="/vault-docs-Zh-CN/document/secrets-engines.html#kv-secrets-engine-version-2" class="sidebar-link">KV Secrets Engine - Version 2</a></li></ul></li><li class="sidebar-sub-header"><a href="/vault-docs-Zh-CN/document/secrets-engines.html#pki-secrets-engine" class="sidebar-link">PKI Secrets Engine</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vault-docs-Zh-CN/document/secrets-engines.html#setup-3" class="sidebar-link">Setup</a></li><li class="sidebar-sub-header"><a href="/vault-docs-Zh-CN/document/secrets-engines.html#usage-3" class="sidebar-link">Usage</a></li><li class="sidebar-sub-header"><a href="/vault-docs-Zh-CN/document/secrets-engines.html#considerations" class="sidebar-link">Considerations</a></li><li class="sidebar-sub-header"><a href="/vault-docs-Zh-CN/document/secrets-engines.html#quick-start" class="sidebar-link">Quick Start</a></li><li class="sidebar-sub-header"><a href="/vault-docs-Zh-CN/document/secrets-engines.html#setting-up-intermediate-ca" class="sidebar-link">Setting Up Intermediate CA</a></li><li class="sidebar-sub-header"><a href="/vault-docs-Zh-CN/document/secrets-engines.html#api" class="sidebar-link">API</a></li></ul></li></ul></li><li><a href="/vault-docs-Zh-CN/document/auth-methods.html" class="sidebar-link">Auth 方法</a></li><li><a href="/vault-docs-Zh-CN/document/audit-device.html" class="sidebar-link">Audit Devices</a></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="secrets-引擎"><a href="#secrets-引擎" aria-hidden="true" class="header-anchor">#</a> Secrets 引擎</h1> <h2 id="overview"><a href="#overview" aria-hidden="true" class="header-anchor">#</a> Overview</h2> <p>Secrets 引擎是存储、生成或加密数据的组件。Secrets 引擎是非常灵活的，所以从它们的功能而言是很容易理解的。Secrets 引擎提供了一些数据集，它们对这些数据
执行一些操作，然后返回一个结果。</p> <p>一些 Secrets 引擎只是简单地存储和读取数据——比如加密的 Redis/Memcached 。其他 Secrets 引擎连接到其他服务，并根据需要生成动态凭据。其他 Secrets 引擎
提供加密服务、totp 生成、证书等等。</p> <p>Secrets 引擎在 Vault 中的一个 <code>path</code> 上启用。当一个请求到达 Vault 时，路由器自动将带有路由前缀的任何东西路由到 secret 引擎。通过这种方式，
每个 secret 引擎都定义了自己的路径和属性。对于用户来说，secret 引擎的行为类似于虚拟文件系统，支持读、写和删除等操作。</p> <h3 id="secrets-engines-lifecycle"><a href="#secrets-engines-lifecycle" aria-hidden="true" class="header-anchor">#</a> Secrets Engines Lifecycle</h3> <p>大多数 Secrets 引擎都可以通过 CLI 或 API 启用、禁用、调优和移动。Vault 以前的版本将这些称为 &quot;mount&quot;，但是这个术语已经被覆盖了。</p> <ul><li><code>Enable</code> - 这将在给定的路径上启用 secret 引擎。除了少数例外，secrets 引擎可以在多个路径上启用。每个 secret 引擎都与它的路径隔离。默认情况下，
它们在与 <code>type</code> 相同的路径上是启用的(例如。<code>aws</code> 默认启用于 <code>aws/</code> 上)。</li> <li><code>Disable</code> - 这将禁用现有的 secrets 引擎。当一个 secrets 引擎被禁用时，它的所有 secrets 都会被撤销(如果它们支持的话)，并且在物理存储层中为该引
擎存储的所有数据都会被删除。</li> <li><code>Move</code> - 这将移动现有的 secrets 引擎的 path。这个过程撤销所有 secrets ，因为 secrets 租约与创建它们的 path 绑定在一起。为引擎存储的配置数据
在移动过程中保持不变。</li> <li><code>Tune</code> - 这将调整 Secrets 引擎(如 TTLs )的全局配置。</li></ul> <p>一旦一个 secret 引擎被启用，就可以根据它自己的 API 在它的路径上直接与它交互。使用 <code>vault path -help</code> 确定它响应的路径。</p> <p>注意，Vault 中的挂载点不能相互冲突。这个事实有两个广泛的含义。首先，你不能有一个以已存在的挂载为前缀的挂载。第二，你不能创建一个名为已存在的挂载前缀的挂载点。
例如，挂载 <code>foo/bar</code> 和 <code>foo/baz</code> 可以和平共处，而 <code>foo</code> 和 <code>foo/baz</code> 则不能</p> <h3 id="barrier-view"><a href="#barrier-view" aria-hidden="true" class="header-anchor">#</a> Barrier View</h3> <p>secret 引擎接受一个 <code>barrier view</code> 已配置的 vault 物理存储。这很像 <a href="https://en.wikipedia.org/wiki/Chroot" target="_blank" rel="noopener noreferrer">chroot<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <p>当启用 secret 引擎时，将生成一个随机 UUID。这将成为该引擎的数据根。每当该引擎写入物理存储层时，它都以该 UUID 文件夹作为前缀。
由于 Vault 存储层不支持相对访问(例如 <code>../</code>)，这使得启用的 secret 引擎不可能访问其他数据。</p> <p>这是 Vault 中一个重要的安全特性 —— 即使一个恶意的引擎也不能访问任何其他引擎的数据。</p> <h2 id="kv-secrets-engine"><a href="#kv-secrets-engine" aria-hidden="true" class="header-anchor">#</a> KV Secrets Engine</h2> <h3 id="overview-2"><a href="#overview-2" aria-hidden="true" class="header-anchor">#</a> Overview</h3> <p><code>kv</code> Secrets 引擎用于存储任意的 secrets 到 Vault 配置的物理存储中。此后端可以以两种模式之一运行。它可以是一个通用的 <code>Key-Value</code> 存储，存储健值对。
可以启用版本控制，并为每个 key 存储可配置的版本号。</p> <h4 id="kv-version-1"><a href="#kv-version-1" aria-hidden="true" class="header-anchor">#</a> KV Version 1</h4> <p>当运行 <code>kv</code> secret backend 无版本控制时，仅保留 key 的最近写入值。无版本 <code>kv</code> 的好处是减少了每个 key 的存储大小，因为不存储额外的元数据或历史记录。
此外，通过这种方式配置到后端的请求将具有更高的性能，因为对于任何给定的请求，将有更少的存储调用，并且没有锁定。</p> <p>有关在这种模式下运行的更多信息可以在 <a href>K/V Version 1 Docs</a> 中找到。</p> <h4 id="kv-version-2"><a href="#kv-version-2" aria-hidden="true" class="header-anchor">#</a> KV Version 2</h4> <p>当运行 v2 版本的 <code>kv</code> 后端时，key 可以保留一定数量可配置的版本。默认为 10 个版本。可以检索旧版本的元数据和数据。此外，可以使用 <code>Check-and-Set</code> 操作来避免无意中覆盖数据。</p> <p>当一个版本被删除时，底层数据并没有被删除，而是被标记为已删除。已删除的版本可以取消删除。要永久删除版本的数据，可以使用 destroy 命令或 API 端点。
此外，可以通过删除 metadata 命令或 API 端点删除 key 的所有版本和元数据。每个操作都可以采用不同的 ACL'ed，从而限制谁具有软删除、取消删除或完全删除数据的权限。</p> <p>有关在这种模式下运行的更多信息可以在 <a href>K/V Version 2 Docs</a> 中找到。</p> <h3 id="kv-secrets-engine-version-1"><a href="#kv-secrets-engine-version-1" aria-hidden="true" class="header-anchor">#</a> KV Secrets Engine - Version 1</h3> <p><code>kv</code> Secrets 引擎用于存储任意的 secrets 到 Vault 配置的物理存储中。</p> <p>写入一个 key 到 <code>kv</code> 后端会替换旧值;子字段不会合并在一起。</p> <p>key 名必须始终是字符串。如果直接通过 CLI 编写非字符串值，它们将被转换成字符串。</p> <p>但是，可以通过编写保存非字符串值的 key/value 对的 JSON 文件传递给 Vault，或使用 HTTP API 进行调用。</p> <p>这个 secret 引擎支持 ACL 策略中的 <code>create</code> 和 <code>update</code> 功能之间的区别。</p> <blockquote><p>Path 和 key 名是不会被加密的，只有 key 的值会被加密。不应该将敏感信息存储在 secret 的 path 中。</p></blockquote> <h4 id="setup"><a href="#setup" aria-hidden="true" class="header-anchor">#</a> Setup</h4> <p>启用一个版本为 1 的 <code>kv</code> 存储：</p> <div class="language-sh extra-class"><pre class="language-text"><code>vault secrets enable -version=1 kv
</code></pre></div><h4 id="usage"><a href="#usage" aria-hidden="true" class="header-anchor">#</a> Usage</h4> <p>在配置了 secret 引擎并且 用户/机器 具有具有适当权限的 Vault 令牌之后，它可以生成凭证。<code>kv</code> secret 引擎允许写入任意的健值对。</p> <ol><li>写入任意数据：</li></ol> <div class="language-sh extra-class"><pre class="language-text"><code>$ vault kv put kv/my-secret my-value=s3cr3t
Success! Data written to: kv/my-secret
</code></pre></div><ol start="2"><li>读取任意数据：</li></ol> <div class="language-sh extra-class"><pre class="language-text"><code>$ vault kv get kv/my-secret
Key                 Value
---                 -----
my-value            s3cr3t
</code></pre></div><ol start="3"><li>列出所有的 keys：</li></ol> <div class="language-sh extra-class"><pre class="language-text"><code>$ vault kv list kv/
Keys
----
my-secret
</code></pre></div><ol start="4"><li>删除一个 key：</li></ol> <div class="language-sh extra-class"><pre class="language-text"><code>$ vault kv delete kv/my-secret
Success! Data deleted (if it existed) at: kv/my-secret
</code></pre></div><h4 id="ttls"><a href="#ttls" aria-hidden="true" class="header-anchor">#</a> TTLs</h4> <p>和其他 secret 引擎不同， <code>kv</code> secret 引擎不强制 TTLs 过期。相反，<code>lease_duration</code> 只是为了提示使用者应该多久检查一次新值。</p> <p>若一个 key 提供了 <code>ttl</code>，KV secret 引擎将以此值作为租期:</p> <div class="language-sh extra-class"><pre class="language-text"><code>$ vault kv put kv/my-secret ttl=30m my-value=s3cr3t
Success! Data written to: kv/my-secret
</code></pre></div><p>即使设置了 <code>ttl</code>，secret 引擎也不会自己删除数据。<code>ttl</code> 的关键仅仅是建议。</p> <p>当读取一个带有 <code>ttl</code> 的值时，<code>ttl</code> 键和刷新间隔都会显示:</p> <div class="language-sh extra-class"><pre class="language-text"><code>$ vault kv get kv/my-secret
Key                 Value
---                 -----
my-value            s3cr3t
ttl                 30m
</code></pre></div><h3 id="kv-secrets-engine-version-2"><a href="#kv-secrets-engine-version-2" aria-hidden="true" class="header-anchor">#</a> KV Secrets Engine - Version 2</h3> <h4 id="setup-2"><a href="#setup-2" aria-hidden="true" class="header-anchor">#</a> Setup</h4> <p>一个 v2 版本的 secret 引擎可以使用下面的命令启用：</p> <div class="language-sh extra-class"><pre class="language-text"><code>$ vault secrets enable -version=2 kv
</code></pre></div><p>或者，你可以通过 <code>kv-v2</code> 作为 secret 引擎类型:</p> <div class="language-sh extra-class"><pre class="language-text"><code>$ vault secrets enable kv-v2
</code></pre></div><p>此外，当运行一个 dev-mode 服务器时，默认情况下在路径 <code>secret/</code> 上启用了v2 kv secret 引擎(对于非开发服务器，当前为 v1)。可以在不同的路径上多次禁用、移动或启用它。
KV secret 引擎的每个实例都是独立且唯一的。</p> <h4 id="upgrading-from-version-1"><a href="#upgrading-from-version-1" aria-hidden="true" class="header-anchor">#</a> Upgrading from Version 1</h4> <p>现有版本 1 的 <code>kv</code> 存储可以通过 CLI 或 API 升级到版本 2，如下所示。这将启动一个升级过程，将现有的 key/value 数据升级为版本化的格式。在此过程中，
挂载将不可访问。这个过程可能需要很长时间，所以要相应地计划。</p> <p>一旦升级到版本 2，以前数据可访问的路径不可以再满足。你需要调整用户策略，以添加对 version 2 路径的访问，详细介绍 <a href>the ACL Rules section</a>。
同样，一旦 kv 数据升级到版本 2，用户/应用程序 将需要更新与 kv 数据交互的路径。</p> <p>现有版本 1 的 <code>kv</code> 存储可以通过 CLI 升级到版本 2:</p> <div class="language-sh extra-class"><pre class="language-text"><code>$ vault kv enable-versioning secret/
Success! Tuned the secrets engine at: secret/
</code></pre></div><p>或者通过 API：</p> <div class="language-sh extra-class"><pre class="language-text"><code>$ cat payload.json
{
  &quot;options&quot;: {
      &quot;version&quot;: &quot;2&quot;
  }
}

$ curl \
    --header &quot;X-Vault-Token: ...&quot; \
    --request POST \
    --data @payload.json \
    http://127.0.0.1:8200/v1/sys/mounts/secret/tune
</code></pre></div><h4 id="acl-rules"><a href="#acl-rules" aria-hidden="true" class="header-anchor">#</a> ACL Rules</h4> <p>版本 2 kv 存储使用前缀 API，这与版本 1 API不同。在从版本 1 kv 升级之前，应该更改 ACL 规则。此外，版本 2 API 中的不同路径可以采用不同的 ACL'ed。</p> <p>写入和读取版本的前缀是 <code>data/</code> 的路径。适用于 1 kv 版本的策略:</p> <div class="language- extra-class"><pre class="language-text"><code>path &quot;secret/dev/team-1/*&quot; {
  capabilities = [&quot;create&quot;, &quot;update&quot;, &quot;read&quot;]
}
</code></pre></div><p>需要改为：</p> <div class="language- extra-class"><pre class="language-text"><code>path &quot;secret/data/dev/team-1/*&quot; {
  capabilities = [&quot;create&quot;, &quot;update&quot;, &quot;read&quot;]
}
</code></pre></div><p>这个后端有不同级别的数据删除。若要授予策略删除 key 最新版本的权限，请:</p> <div class="language- extra-class"><pre class="language-text"><code>path &quot;secret/data/dev/team-1/*&quot; {
  capabilities = [&quot;delete&quot;]
}
</code></pre></div><p>允许策略删除任何版本的 key:</p> <div class="language- extra-class"><pre class="language-text"><code>path &quot;secret/delete/dev/team-1/*&quot; {
  capabilities = [&quot;update&quot;]
}
</code></pre></div><p>允许策略取消删除数据:</p> <div class="language- extra-class"><pre class="language-text"><code>path &quot;secret/undelete/dev/team-1/*&quot; {
  capabilities = [&quot;update&quot;]
}
</code></pre></div><p>允许策略销毁版本:</p> <div class="language- extra-class"><pre class="language-text"><code>path &quot;secret/destroy/dev/team-1/*&quot; {
  capabilities = [&quot;update&quot;]
}
</code></pre></div><p>允许策略列出所有的 key:</p> <div class="language- extra-class"><pre class="language-text"><code>path &quot;secret/metadata/dev/team-1/*&quot; {
  capabilities = [&quot;list&quot;]
}
</code></pre></div><p>允许策略读取每个版本的元数据:</p> <div class="language- extra-class"><pre class="language-text"><code>path &quot;secret/metadata/dev/team-1/*&quot; {
  capabilities = [&quot;read&quot;]
}
</code></pre></div><p>允许策略永久删除 key 的所有版本和元数据:</p> <div class="language- extra-class"><pre class="language-text"><code>path &quot;secret/metadata/dev/team-1/*&quot; {
  capabilities = [&quot;delete&quot;]
}
</code></pre></div><h4 id="usage-2"><a href="#usage-2" aria-hidden="true" class="header-anchor">#</a> Usage</h4> <h5 id="writing-reading-arbitrary-data"><a href="#writing-reading-arbitrary-data" aria-hidden="true" class="header-anchor">#</a> Writing/Reading arbitrary data</h5> <ol><li>写入任意数据：</li></ol> <div class="language-sh extra-class"><pre class="language-text"><code>$ vault kv put secret/my-secret my-value=s3cr3t
Key              Value
---              -----
created_time     2018-03-30T22:11:48.589157362Z
deletion_time    n/a
destroyed        false
version          1
</code></pre></div><ol start="2"><li>读取任意数据：</li></ol> <div class="language-sh extra-class"><pre class="language-text"><code>$ vault kv get secret/my-secret
====== Metadata ======
Key              Value
---              -----
created_time     2018-03-30T22:11:48.589157362Z
deletion_time    n/a
destroyed        false
version          1

====== Data ======
Key         Value
---         -----
my-value    s3cr3t
</code></pre></div><ol start="3"><li>写入另一个版本，仍然可以访问以前的版本。可以选择传递 <code>-cas</code> 标志来执行 <code>check-and-set</code> 操作。如果没有设置，那么写操作是允许的。如果设置 <code>-cas=0</code>，则仅在 key 不存在的情况下才
允许写入。如果索引非零，则仅当 key 的当前版本与 <code>cas</code> 参数中指定的版本匹配时才允许写入。</li></ol> <div class="language-sh extra-class"><pre class="language-text"><code>$ vault kv put -cas=1 secret/my-secret my-value=new-s3cr3t
Key              Value
---              -----
created_time     2018-03-30T22:18:37.124228658Z
deletion_time    n/a
destroyed        false
version          2
</code></pre></div><ol start="4"><li>现在读取将返回最新版本的数据:</li></ol> <div class="language-sh extra-class"><pre class="language-text"><code>$ vault kv get secret/my-secret
====== Metadata ======
Key              Value
---              -----
created_time     2018-03-30T22:18:37.124228658Z
deletion_time    n/a
destroyed        false
version          2

====== Data ======
Key         Value
---         -----
my-value    new-s3cr3t
</code></pre></div><ol start="5"><li>之前的版本可以通过 <code>-version</code> 标志来访问：</li></ol> <div class="language-sh extra-class"><pre class="language-text"><code>$ vault kv get -version=1 secret/my-secret
====== Metadata ======
Key              Value
---              -----
created_time     2018-03-30T22:16:39.808909557Z
deletion_time    n/a
destroyed        false
version          1

====== Data ======
Key         Value
---         -----
my-value    s3cr3t
</code></pre></div><h5 id="deleting-and-destroying-data"><a href="#deleting-and-destroying-data" aria-hidden="true" class="header-anchor">#</a> Deleting and Destroying Data</h5> <p>当执行标准命令 <code>vault kv delete</code> 删除数据时会执行<strong>软删除</strong>。它将把版本标记为已删除，并填充一个 <code>deletion_time</code> 时间戳。
软删除不会从底层存储删除版本数据，这样的话，允许撤销删除版本。命令 <code>vault kv undelete</code> 是用来处理版本的撤销删除。当使用 destroy 命令时，底层的版本数据将被删除，
key 元数据将被标记为已销毁。</p> <p>只有当 key 的版本数超过 <code>max-versions</code> 设置所允许的版本数时，或者当使用 <code>vault kv destroy</code> 时，版本的数据才会被永久删除。
如果超过了 <code>max-versions</code> 而清除了某个版本，那么版本元数据也将从 key 中删除。</p> <p>有关更多信息，参阅下面的命令:</p> <ol><li>一个 key 的最新版本可以用 delete 命令删除，删除之前的版本需要 <code>-versions</code> 标志:</li></ol> <div class="language-sh extra-class"><pre class="language-text"><code>$ vault kv delete secret/my-secret
Success! Data deleted (if it existed) at: secret/my-secret
</code></pre></div><ol start="2"><li>撤销删除版本：</li></ol> <div class="language-sh extra-class"><pre class="language-text"><code>$ vault kv undelete -versions=2 secret/my-secret
Success! Data written to: secret/undelete/my-secret

$ vault kv get secret/my-secret
====== Metadata ======
Key              Value
---              -----
created_time     2018-03-30T22:18:37.124228658Z
deletion_time    n/a
destroyed        false
version          2

====== Data ======
Key         Value
---         -----
my-value    new-s3cr3t
</code></pre></div><ol start="3"><li>销毁一个版本永久删除底层数据:</li></ol> <div class="language-sh extra-class"><pre class="language-text"><code>$ vault kv destroy -versions=2 secret/my-secret
Success! Data written to: secret/destroy/my-secret
</code></pre></div><h5 id="key-metadata"><a href="#key-metadata" aria-hidden="true" class="header-anchor">#</a> Key Metadata</h5> <p>可以使用 metadata 命令 &amp; API跟 踪所有版本和 key 元数据。删除元数据 key 将导致永久删除该 key 的所有元数据和版本。</p> <p>有关更多信息，参阅下面的命令:</p> <ol><li>key 的所有元数据和版本都可以查看:</li></ol> <div class="language-sh extra-class"><pre class="language-text"><code>$ vault kv metadata get secret/my-secret
======= Metadata =======
Key                Value
---                -----
created_time       2018-03-30T22:16:39.808909557Z
current_version    2
max_versions       0
oldest_version     0
updated_time       2018-03-30T22:18:37.124228658Z

====== Version 1 ======
Key              Value
---              -----
created_time     2018-03-30T22:16:39.808909557Z
deletion_time    n/a
destroyed        false

====== Version 2 ======
Key              Value
---              -----
created_time     2018-03-30T22:18:37.124228658Z
deletion_time    n/a
destroyed        true
</code></pre></div><ol start="2"><li>key 的元数据设置可以配置:</li></ol> <div class="language-sh extra-class"><pre class="language-text"><code>$ vault kv metadata put -max-versions 1 secret/my-secret
Success! Data written to: secret/metadata/my-secret
</code></pre></div><p>最大版本的变化适用于下一个写操作:</p> <div class="language-sh extra-class"><pre class="language-text"><code>$ vault kv put secret/my-secret my-value=newer-s3cr3t
Key              Value
---              -----
created_time     2018-03-30T22:41:09.193643571Z
deletion_time    n/a
destroyed        false
version          3
</code></pre></div><p>一旦一个 key 的版本数量超过最大版本数，最老的版本就会被清除:</p> <div class="language-sh extra-class"><pre class="language-text"><code>$ vault kv metadata get secret/my-secret
======= Metadata =======
Key                Value
---                -----
created_time       2018-03-30T22:16:39.808909557Z
current_version    3
max_versions       1
oldest_version     3
updated_time       2018-03-30T22:41:09.193643571Z

====== Version 3 ======
Key              Value
---              -----
created_time     2018-03-30T22:41:09.193643571Z
deletion_time    n/a
destroyed        false
</code></pre></div><ol start="3"><li>永久删除一个 key 的所有元数据和版本:</li></ol> <div class="language-sh extra-class"><pre class="language-text"><code>$ vault kv metadata delete secret/my-secret
Success! Data deleted (if it existed) at: secret/metadata/my-secret
</code></pre></div><h2 id="pki-secrets-engine"><a href="#pki-secrets-engine" aria-hidden="true" class="header-anchor">#</a> PKI Secrets Engine</h2> <p>PKI secrets 引擎生成动态 <code>X.509</code> 证书。使用这个 secrets 引擎，服务可以获得证书，而不需要手动生成私钥和 CSR，提交到 CA，并等待验证和签名完成。
Vault 的内置身份验证和授权机制提供了验证功能。</p> <p>通过保持相对较短的 TTL，不太可能需要撤销操作，保持 CRL 简短并帮助 secrets 引擎扩展到大型工作负载。 反过来就允许每个正在运行的应用程序实例都具有唯一的证书，
从而消除了共享以及随之而来的撤销和反复的痛苦。</p> <p>此外，允许撤销操作主要是放弃证书，这个 secrets 引擎允许短暂的证书。应用程序启动时可以获取证书并将其存储在内存中，并在关闭时丢弃，而不必写入磁盘。</p> <h3 id="setup-3"><a href="#setup-3" aria-hidden="true" class="header-anchor">#</a> Setup</h3> <p>大多数 secrets 引擎必须事先配置才能执行其功能。 这些步骤通常由操作员或配置管理工具完成。</p> <ol><li>启用 PKI secrets 引擎：</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code>$ vault secrets <span class="token function">enable</span> pki
Success<span class="token operator">!</span> Enabled the pki secrets engine at: pki/
</code></pre></div><p><strong>默认情况下，secrets 引擎将安装在引擎名称同名的路径上</strong>。要在不同路径上启用 secrets 引擎，使用 <code>-path</code> 参数。</p> <ol start="2"><li>调整 secrets 引擎，增加 TTL。 默认值 30 天可能太短，因此将其增加到 1 年：</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code>$ vault secrets tune -max-lease-ttl<span class="token operator">=</span>8760h pki
Success<span class="token operator">!</span> Tuned the secrets engine at: pki/
</code></pre></div><p>注意，这只是配置这个 secrets 引擎的全局的最大值。每个角色可以把每个证书的 TTL 限制为更短。</p> <ol start="3"><li>配置 CA 证书和私钥。 Vault 可以接受现有密钥对，也可以生成自己的自签名根。通常，我们建议将**根 CA **保留在 Vault 之外，并为 Vault 提供签名的中间 CA。</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code>$ vault <span class="token function">write</span> pki/root/generate/internal \
    common_name<span class="token operator">=</span>my-website.com \
    ttl<span class="token operator">=</span>8760h

Key              Value
---              -----
certificate      -----BEGIN CERTIFICATE-----<span class="token punctuation">..</span>.
expiration       1536807433
issuing_ca       -----BEGIN CERTIFICATE-----<span class="token punctuation">..</span>.
serial_number    7c:f1:fb:2c:6e:4d:99:0e:82:1b:08:0a:81:ed:61:3e:1d:fa:f5:29
</code></pre></div><p>返回的证书纯粹是提供信息。 私钥安全地存储在 Vault 内部。</p> <ol start="4"><li>更新 CRL 位置并颁发证书。 这些值可以在以后更新。</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code>$ vault <span class="token function">write</span> pki/config/urls \
    issuing_certificates<span class="token operator">=</span><span class="token string">&quot;http://127.0.0.1:8200/v1/pki/ca&quot;</span> \
    crl_distribution_points<span class="token operator">=</span><span class="token string">&quot;http://127.0.0.1:8200/v1/pki/crl&quot;</span>
Success<span class="token operator">!</span> Data written to: pki/config/urls
</code></pre></div><ol start="5"><li>配置一个 <code>role</code>，在 Vault 中的映射一个名字到生成证书的过程中。 当用户或计算机生成凭据时，将根据此角色生成凭据：</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code>$ vault <span class="token function">write</span> pki/roles/my-role \
    allowed_domains<span class="token operator">=</span>my-website.com \
    allow_subdomains<span class="token operator">=</span>true \
    max_ttl<span class="token operator">=</span>72h
Success<span class="token operator">!</span> Data written to: pki/roles/my-role
</code></pre></div><h3 id="usage-3"><a href="#usage-3" aria-hidden="true" class="header-anchor">#</a> Usage</h3> <p>配置好 secrets 引擎并且用户或者计算机有了一个一定权限的 <code>Vault token</code>，就可以生成凭据。</p> <ol><li>通过写入 <code>/issue</code> 端点，并带上 <code>role name</code>，来生成新凭据：</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code>$ vault <span class="token function">write</span> pki/issue/my-role \
    common_name<span class="token operator">=</span>www.my-website.com

Key                 Value
---                 -----
certificate         -----BEGIN CERTIFICATE-----<span class="token punctuation">..</span>.
issuing_ca          -----BEGIN CERTIFICATE-----<span class="token punctuation">..</span>.
private_key         -----BEGIN RSA PRIVATE KEY-----<span class="token punctuation">..</span>.
private_key_type    rsa
serial_number       1d:2e:c6:06:45:18:60:0e:23:d6:c5:17:43:c0:fe:46:ed:d1:50:be
</code></pre></div><p>输出中会包含一个动态生成的私钥和证书，它对应了给定的 <code>role</code>，并在 72h 到期（由我们的 <code>role</code> 定义决定）。为了简化自动化，还会返回 <code>issuing_ca</code> 和信任链。</p> <h3 id="considerations"><a href="#considerations" aria-hidden="true" class="header-anchor">#</a> Considerations</h3> <p>要成功部署这个 secrets 引擎，需要考虑到一些重要的因素，以及应该采取的一些准备步骤。 在使用这个 secrets 引擎或生成 CA 以使用此 secrets 引擎之前，应该阅读所有这些内容。</p> <h4 id="be-careful-with-root-cas"><a href="#be-careful-with-root-cas" aria-hidden="true" class="header-anchor">#</a> Be Careful with Root CAs</h4> <p>Vault 存储是安全的，但不如银行保险库中的纸张安全。毕竟，这是网络软件。<strong>如果你的 <code>根 CA</code> 托管在 Vault 之外，请不要将其放在 Vault 中;相反，发出一个寿命较短的中间 CA 证书并将
其放入 Vault。这符合行业最佳实践</strong>。</p> <p>从 0.4 开始，secrets 引擎支持生成自签名 <code>根 CA</code> 以及为 <code>中间 CA</code> 创建和签署 CSR。在每个实例中，出于安全原因，私钥只能在生成时导出，并且执行此操作的能力是命令路径的
一部分（因此可以将其放入 ACL 策略中）。</p> <p>如果你计划将 <code>中间 CA</code> 与 Vault 一起使用，建议让 Vault 创建 CSR 并且不导出私钥，然后使用 <code>根CA</code>（可能是 pki secrets 引擎的第二个挂载）对其进行签名。</p> <h4 id="one-ca-certificate-one-secrets-engine"><a href="#one-ca-certificate-one-secrets-engine" aria-hidden="true" class="header-anchor">#</a> One CA Certificate, One Secrets Engine</h4> <p>为了简化 PKI secrets 引擎的配置和代码库，每个 secrets 引擎只允许一个 CA 证书。 如果要从多个 CA 颁发证书，将 PKI secrets 引擎安装在多个安装点，每个安装点都
有单独的 CA 证书。</p> <p>这也提供了一种切换到新 CA 证书的便捷方法，同时保持 CRL 对旧 CA 证书有效; 只需安装一个新的 secrets 引擎并从那里发出。</p> <p>常见模式是将一个安装程序用作 <code>根 CA</code>，并仅使用此 CA 从其他 PKI secrets 引擎签署中间 CA CSR。</p> <h4 id="keep-certificate-lifetimes-short-for-crl-s-sake"><a href="#keep-certificate-lifetimes-short-for-crl-s-sake" aria-hidden="true" class="header-anchor">#</a> Keep certificate lifetimes short, for CRL's sake</h4> <p>这个 secrets 引擎与 Vault 短暂的 secrets 理念保持一致。 因此，预计 CRL 不会增长; 唯一返回私钥的地方是请求客户端（此 secrets 引擎不存储生成的私钥，CA 证书除外）。
在大多数情况下，如果密钥丢失，则可以简单地忽略证书，因为它很快就会过期。</p> <p>如果必须撤销证书，则可以使用正常的 Vault 撤销功能; 或者，可以使用根令牌来使用证书的序列号撤销证书。任何撤销操作都将导致重新生成 CRL。重新生成 CRL 时，将从 CRL 中删除所
有过期的证书（并且从 secrets 引擎存储中删除任何已撤销的过期证书）。</p> <p>这个 secrets 引擎不支持具有滑动日期窗口的多个 CRL 端点; 通常这样的机制将具有相隔几天的转换点，但是这进入了从这个 secrets 引擎发出的实际证书有效期的预期范围。
这个 secrets 引擎的一个好的经验法则是不发布有效期大于最大舒适 CRL 生命周期的证书。 或者，可以控制客户端上的CRL缓存行为，以确保更频繁地进行检查。</p> <p>通常在单个 CRL 端点关闭时使用多个端点，以便客户端不必弄清楚如何处理缺少响应。 在 HA 模式下运行 Vault，即使特定节点关闭，CRL 端点也应可用。</p> <h4 id="you-must-configure-issuing-crl-ocsp-information-in-advance"><a href="#you-must-configure-issuing-crl-ocsp-information-in-advance" aria-hidden="true" class="header-anchor">#</a> You must configure issuing/CRL/OCSP information in advance</h4> <p>这个 secrets 引擎从可预测的位置提供 CRL，但 secrets 引擎不可能知道它在哪里运行。因此，必须使用 <code>config/urls</code> 端点手动为颁发证书，CRL 分发点和 OCSP 服务器配置所需的 URL。
通过将多个URL作为逗号分隔的字符串参数传递，支持它们中的每一个都有多个。</p> <h4 id="safe-minimums"><a href="#safe-minimums" aria-hidden="true" class="header-anchor">#</a> Safe Minimums</h4> <p>自成立以来，这个秘密引擎已经强制使用 SHA256 签名哈希而不是 SHA1。 从 0.5.1 开始，RSA 密钥的最小值为 2048 位。 可以处理 SHA256 签名的软件也应该能够处理 2048 位密钥，
并且 1024 位密钥被认为是不安全的，并且在 Internet PKI 中是不允许的。</p> <h4 id="token-lifetimes-and-revocation"><a href="#token-lifetimes-and-revocation" aria-hidden="true" class="header-anchor">#</a> Token Lifetimes and Revocation</h4> <p>当令牌到期时，它会撤销与之关联的所有租约。 这意味着长期使用的 CA 证书需要相应的长期令牌，这很容易被遗忘。 从 0.6 开始，<code>根 CA</code> 和 <code>中间 CA</code> 证书不再具有关联租约，
以防止在不使用具有足够长寿命的令牌时意外撤销。要撤消这些证书，使用 <code>pki/revoke</code> 端点。</p> <h3 id="quick-start"><a href="#quick-start" aria-hidden="true" class="header-anchor">#</a> Quick Start</h3> <h4 id="mount-the-backend"><a href="#mount-the-backend" aria-hidden="true" class="header-anchor">#</a> Mount the backend</h4> <p>使用 <code>pki</code> 后端的第一步是挂载它。 与 <code>kv</code> 后端不同，默认情况下不会安装 <code>pki</code> 后端。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ vault secrets <span class="token function">enable</span> pki
Successfully mounted <span class="token string">'pki'</span> at <span class="token string">'pki'</span><span class="token operator">!</span>
</code></pre></div><h4 id="configure-a-ca-certificate"><a href="#configure-a-ca-certificate" aria-hidden="true" class="header-anchor">#</a> Configure a CA certificate</h4> <p>下一步，必须使用 CA 证书和关联的私钥配置 Vault。 我们将利用后端的自签名根生成支持，但 Vault 还支持生成 <code>中间 CA</code>（使用CSR进行签名）或将 PEM 编码的证书和私钥包直接设
置到后端。</p> <p>通常，希望根证书仅用于签署 CA 中间证书，但是对于此示例，我们将继续执行，将直接从根颁发证书。 因为它是根，我们要为证书设置一个很长的最大生命周期; 首先调整：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ vault secrets tune -max-lease-ttl<span class="token operator">=</span>87600h pki
Successfully tuned <span class="token function">mount</span> <span class="token string">'pki'</span><span class="token operator">!</span>
</code></pre></div><p>这里设置 secrets 的从挂载发出后的最大 TTL 为 10 年。 （请注意，<code>role</code> 可以进一步限制最大 TTL。）</p> <p>现在，生成根证书：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ vault <span class="token function">write</span> pki/root/generate/internal common_name<span class="token operator">=</span>myvault.com ttl<span class="token operator">=</span>87600h
Key             Value
---             -----
certificate     -----BEGIN CERTIFICATE-----
MIIDNTCCAh2gAwIBAgIUJqrw/9EDZbp4DExaLjh0vSAHyBgwDQYJKoZIhvcNAQEL
BQAwFjEUMBIGA1UEAxMLbXl2YXVsdC5jb20wHhcNMTcxMjA4MTkyMzIwWhcNMjcx
MjA2MTkyMzQ5WjAWMRQwEgYDVQQDEwtteXZhdWx0LmNvbTCCASIwDQYJKoZIhvcN
AQEBBQADggEPADCCAQoCggEBAKY/vJ6sRFym+yFYUneoVtDmOCaDKAQiGzQw0IXL
wgMBBb82iKpYj5aQjXZGIl+VkVnCi+M2AQ/iYXWZf1kTAdle4A6OC4+VefSIa2b4
eB7R8aiGTce62jB95+s5/YgrfIqk6igfpCSXYLE8ubNDA2/+cqvjhku1UzlvKBX2
hIlgWkKlrsnybHN+B/3Usw9Km/87rzoDR3OMxLV55YPHiq6+olIfSSwKAPjH8LZm
uM1ITLG3WQUl8ARF17Dj+wOKqbUG38PduVwKL5+qPksrvNwlmCP7Kmjncc6xnYp6
5lfr7V4DC/UezrJYCIb0g/SvtxoN1OuqmmvSTKiEE7hVOAcCAwEAAaN7MHkwDgYD
VR0PAQH/BAQDAgEGMA8GA1UdEwEB/wQFMAMBAf8wHQYDVR0OBBYEFECKdYM4gDbM
kxRZA2wR4f/yNhQUMB8GA1UdIwQYMBaAFECKdYM4gDbMkxRZA2wR4f/yNhQUMBYG
A1UdEQQPMA2CC215dmF1bHQuY29tMA0GCSqGSIb3DQEBCwUAA4IBAQCCJKZPcjjn
7mvD2+sr6lx4DW/vJwVSW8eTuLtOLNu6/aFhcgTY/OOB8q4n6iHuLrEt8/RV7RJI
obRx74SfK9BcOLt4+DHGnFXqu2FNVnhDMOKarj41yGyXlJaQRUPYf6WJJLF+ZphN
nNsZqHJHBfZtpJpE5Vywx3pah08B5yZHk1ItRPEz7EY3uwBI/CJoBb+P5Ahk6krc
LZ62kFwstkVuFp43o3K7cRNexCIsZGx2tsyZ0nyqDUFsBr66xwUfn3C+/1CDc9YL
zjq+8nI2ooIrj4ZKZCOm2fKd1KeGN/CZD7Ob6uNhXrd0Tjwv00a7nffvYQkl/1V5
BT55jevSPVVu
-----END CERTIFICATE-----
expiration      1828121029
issuing_ca      -----BEGIN CERTIFICATE-----
MIIDNTCCAh2gAwIBAgIUJqrw/9EDZbp4DExaLjh0vSAHyBgwDQYJKoZIhvcNAQEL
BQAwFjEUMBIGA1UEAxMLbXl2YXVsdC5jb20wHhcNMTcxMjA4MTkyMzIwWhcNMjcx
MjA2MTkyMzQ5WjAWMRQwEgYDVQQDEwtteXZhdWx0LmNvbTCCASIwDQYJKoZIhvcN
AQEBBQADggEPADCCAQoCggEBAKY/vJ6sRFym+yFYUneoVtDmOCaDKAQiGzQw0IXL
wgMBBb82iKpYj5aQjXZGIl+VkVnCi+M2AQ/iYXWZf1kTAdle4A6OC4+VefSIa2b4
eB7R8aiGTce62jB95+s5/YgrfIqk6igfpCSXYLE8ubNDA2/+cqvjhku1UzlvKBX2
hIlgWkKlrsnybHN+B/3Usw9Km/87rzoDR3OMxLV55YPHiq6+olIfSSwKAPjH8LZm
uM1ITLG3WQUl8ARF17Dj+wOKqbUG38PduVwKL5+qPksrvNwlmCP7Kmjncc6xnYp6
5lfr7V4DC/UezrJYCIb0g/SvtxoN1OuqmmvSTKiEE7hVOAcCAwEAAaN7MHkwDgYD
VR0PAQH/BAQDAgEGMA8GA1UdEwEB/wQFMAMBAf8wHQYDVR0OBBYEFECKdYM4gDbM
kxRZA2wR4f/yNhQUMB8GA1UdIwQYMBaAFECKdYM4gDbMkxRZA2wR4f/yNhQUMBYG
A1UdEQQPMA2CC215dmF1bHQuY29tMA0GCSqGSIb3DQEBCwUAA4IBAQCCJKZPcjjn
7mvD2+sr6lx4DW/vJwVSW8eTuLtOLNu6/aFhcgTY/OOB8q4n6iHuLrEt8/RV7RJI
obRx74SfK9BcOLt4+DHGnFXqu2FNVnhDMOKarj41yGyXlJaQRUPYf6WJJLF+ZphN
nNsZqHJHBfZtpJpE5Vywx3pah08B5yZHk1ItRPEz7EY3uwBI/CJoBb+P5Ahk6krc
LZ62kFwstkVuFp43o3K7cRNexCIsZGx2tsyZ0nyqDUFsBr66xwUfn3C+/1CDc9YL
zjq+8nI2ooIrj4ZKZCOm2fKd1KeGN/CZD7Ob6uNhXrd0Tjwv00a7nffvYQkl/1V5
BT55jevSPVVu
-----END CERTIFICATE-----
serial_number   26:aa:f0:ff:d1:03:65:ba:78:0c:4c:5a:2e:38:74:bd:20:07:c8:18
</code></pre></div><p>返回的证书纯粹是信息性的; 它及其私钥安全地存储在后端挂载中。</p> <h4 id="set-url-configuration"><a href="#set-url-configuration" aria-hidden="true" class="header-anchor">#</a> Set URL configuration</h4> <p>生成的证书可以具有 CRL 位置和颁发证书编码的位置。 这些值必须手动设置，通常设置为与 Vault 服务器关联的 FQDN，但可以随时更改。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ vault <span class="token function">write</span> pki/config/urls issuing_certificates<span class="token operator">=</span><span class="token string">&quot;http://vault.example.com:8200/v1/pki/ca&quot;</span> crl_distribution_points<span class="token operator">=</span><span class="token string">&quot;http://vault.example.com:8200/v1/pki/crl&quot;</span>
Success<span class="token operator">!</span> Data written to: pki/ca/urls
</code></pre></div><h4 id="configure-a-role"><a href="#configure-a-role" aria-hidden="true" class="header-anchor">#</a> Configure a role</h4> <p>下一步是配置 <code>role</code>。 <code>role</code> 是映射到用于生成这些凭据的策略的逻辑名称。 例如，我们创建一个 “example-dot-com” 的 <code>role</code>：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ vault <span class="token function">write</span> pki/roles/example-dot-com \
    allowed_domains<span class="token operator">=</span>example.com \
    allow_subdomains<span class="token operator">=</span>true max_ttl<span class="token operator">=</span>72h
Success<span class="token operator">!</span> Data written to: pki/roles/example-dot-com
</code></pre></div><h4 id="issue-certificates"><a href="#issue-certificates" aria-hidden="true" class="header-anchor">#</a> Issue Certificates</h4> <p>通过写入 <code>roles/example-dot-com</code> 路径，我们定义了 <code>example-dot-com</code> 角色。要生成新证书，我们只需使用该 <code>role</code> 名称写入 <code>issue</code> 端点：Vault 现已配置好，可以创建和管理证书。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ vault <span class="token function">write</span> pki/issue/example-dot-com \
    common_name<span class="token operator">=</span>blah.example.com
Key                 Value
---                 -----
certificate         -----BEGIN CERTIFICATE-----
MIIDvzCCAqegAwIBAgIUWQuvpMpA2ym36EoiYyf3Os5UeIowDQYJKoZIhvcNAQEL
BQAwFjEUMBIGA1UEAxMLbXl2YXVsdC5jb20wHhcNMTcxMjA4MTkyNDA1WhcNMTcx
MjExMTkyNDM1WjAbMRkwFwYDVQQDExBibGFoLmV4YW1wbGUuY29tMIIBIjANBgkq
hkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA1CU93lVgcLXGPxRGTRT3GM5wqytCo7Z6
gjfoHyKoPCAqjRdjsYgp1FMvumNQKjUat5KTtr2fypbOnAURDCh4bN/omcj7eAqt
ldJ8mf8CtKUaaJ1kp3R6RRFY/u96BnmKUG8G7oDeEDsKlXuEuRcNbGlGF8DaM/O1
HFa57cM/8yFB26Nj5wBoG5Om6ee5+W+14Qee8AB6OJbsf883Z+zvhJTaB0QM4ZUq
uAMoMVEutWhdI5EFm5OjtMeMu2U+iJl2XqqgQ/JmLRjRdMn1qd9TzTaVSnjoZ97s
jHK444Px1m45einLqKUJ+Ia2ljXYkkItJj9Ut6ZSAP9fHlAtX84W3QIDAQABo4H/
MIH8MA4GA1UdDwEB/wQEAwIDqDAdBgNVHSUEFjAUBggrBgEFBQcDAQYIKwYBBQUH
AwIwHQYDVR0OBBYEFH/YdObW6T94U0zuU5hBfTfU5pt1MB8GA1UdIwQYMBaAFECK
dYM4gDbMkxRZA2wR4f/yNhQUMDsGCCsGAQUFBwEBBC8wLTArBggrBgEFBQcwAoYf
aHR0cDovLzEyNy4wLjAuMTo4MjAwL3YxL3BraS9jYTAbBgNVHREEFDASghBibGFo
LmV4YW1wbGUuY29tMDEGA1UdHwQqMCgwJqAkoCKGIGh0dHA6Ly8xMjcuMC4wLjE6
ODIwMC92MS9wa2kvY3JsMA0GCSqGSIb3DQEBCwUAA4IBAQCDXbHV68VayweB2tkb
KDdCaveaTULjCeJUnm9UT/6C0YqC/RxTAjdKFrilK49elOA3rAtEL6dmsDP2yH25
ptqi2iU+y99HhZgu0zkS/p8elYN3+l+0O7pOxayYXBkFf5t0TlEWSTb7cW+Etz/c
MvSqx6vVvspSjB0PsA3eBq0caZnUJv2u/TEiUe7PPY0UmrZxp/R/P/kE54yI3nWN
4Cwto6yUwScOPbVR1d3hE2KU2toiVkEoOk17UyXWTokbG8rG0KLj99zu7my+Fyre
sjV5nWGDSMZODEsGxHOC+JgNAC1z3n14/InFNOsHICnA5AnJzQdSQQjvcZHN2NyW
+t4f
-----END CERTIFICATE-----
issuing_ca          -----BEGIN CERTIFICATE-----
MIIDNTCCAh2gAwIBAgIUJqrw/9EDZbp4DExaLjh0vSAHyBgwDQYJKoZIhvcNAQEL
BQAwFjEUMBIGA1UEAxMLbXl2YXVsdC5jb20wHhcNMTcxMjA4MTkyMzIwWhcNMjcx
MjA2MTkyMzQ5WjAWMRQwEgYDVQQDEwtteXZhdWx0LmNvbTCCASIwDQYJKoZIhvcN
AQEBBQADggEPADCCAQoCggEBAKY/vJ6sRFym+yFYUneoVtDmOCaDKAQiGzQw0IXL
wgMBBb82iKpYj5aQjXZGIl+VkVnCi+M2AQ/iYXWZf1kTAdle4A6OC4+VefSIa2b4
eB7R8aiGTce62jB95+s5/YgrfIqk6igfpCSXYLE8ubNDA2/+cqvjhku1UzlvKBX2
hIlgWkKlrsnybHN+B/3Usw9Km/87rzoDR3OMxLV55YPHiq6+olIfSSwKAPjH8LZm
uM1ITLG3WQUl8ARF17Dj+wOKqbUG38PduVwKL5+qPksrvNwlmCP7Kmjncc6xnYp6
5lfr7V4DC/UezrJYCIb0g/SvtxoN1OuqmmvSTKiEE7hVOAcCAwEAAaN7MHkwDgYD
VR0PAQH/BAQDAgEGMA8GA1UdEwEB/wQFMAMBAf8wHQYDVR0OBBYEFECKdYM4gDbM
kxRZA2wR4f/yNhQUMB8GA1UdIwQYMBaAFECKdYM4gDbMkxRZA2wR4f/yNhQUMBYG
A1UdEQQPMA2CC215dmF1bHQuY29tMA0GCSqGSIb3DQEBCwUAA4IBAQCCJKZPcjjn
7mvD2+sr6lx4DW/vJwVSW8eTuLtOLNu6/aFhcgTY/OOB8q4n6iHuLrEt8/RV7RJI
obRx74SfK9BcOLt4+DHGnFXqu2FNVnhDMOKarj41yGyXlJaQRUPYf6WJJLF+ZphN
nNsZqHJHBfZtpJpE5Vywx3pah08B5yZHk1ItRPEz7EY3uwBI/CJoBb+P5Ahk6krc
LZ62kFwstkVuFp43o3K7cRNexCIsZGx2tsyZ0nyqDUFsBr66xwUfn3C+/1CDc9YL
zjq+8nI2ooIrj4ZKZCOm2fKd1KeGN/CZD7Ob6uNhXrd0Tjwv00a7nffvYQkl/1V5
BT55jevSPVVu
-----END CERTIFICATE-----
private_key         -----BEGIN RSA PRIVATE KEY-----
MIIEpAIBAAKCAQEA1CU93lVgcLXGPxRGTRT3GM5wqytCo7Z6gjfoHyKoPCAqjRdj
sYgp1FMvumNQKjUat5KTtr2fypbOnAURDCh4bN/omcj7eAqtldJ8mf8CtKUaaJ1k
p3R6RRFY/u96BnmKUG8G7oDeEDsKlXuEuRcNbGlGF8DaM/O1HFa57cM/8yFB26Nj
5wBoG5Om6ee5+W+14Qee8AB6OJbsf883Z+zvhJTaB0QM4ZUquAMoMVEutWhdI5EF
m5OjtMeMu2U+iJl2XqqgQ/JmLRjRdMn1qd9TzTaVSnjoZ97sjHK444Px1m45einL
qKUJ+Ia2ljXYkkItJj9Ut6ZSAP9fHlAtX84W3QIDAQABAoIBAQCf5YIANfF+gkNt
/+YM6yRi+hZJrU2I/1zPETxPW1vaFZR8y4hEoxCEDD8JCRm+9k+w1TWoorvxgkEv
r1HuDALYbNtwLd/71nCHYCKyH1b2uQpyl07qOAyASlb9r5oVjz4E6eobkd3N9fJA
QN0EdK+VarN968mLJsD3Hxb8chGdObBCQ+LO+zdqQLaz+JwhfnK98rm6huQtYK3w
ccd0OwoVmtZz2eJl11TJkB9fi4WqJyxl4wST7QC80LstB1deR78oDmN5WUKU12+G
4Mrgc1hRwUSm18HTTgAhaA4A3rjPyirBohb5Sf+jJxusnnay7tvWeMnIiRI9mqCE
dr3tLrcxAoGBAPL+jHVUF6sxBqm6RTe8Ewg/8RrGmd69oB71QlVUrLYyC96E2s56
19dcyt5U2z+F0u9wlwR1rMb2BJIXbxlNk+i87IHmpOjCMS38SPZYWLHKj02eGfvA
MjKKqEjNY/md9eVAVZIWSEy63c4UcBK1qUH3/5PNlyjk53gCOI/4OXX/AoGBAN+A
Alyd6A/pyHWq8WMyAlV18LnzX8XktJ07xrNmjbPGD5sEHp+Q9V33NitOZpu3bQL+
gCNmcrodrbr9LBV83bkAOVJrf82SPaBesV+ATY7ZiWpqvHTmcoS7nglM2XTr+uWR
Y9JGdpCE9U5QwTc6qfcn7Eqj7yNvvHMrT+1SHwsjAoGBALQyQEbhzYuOF7rV/26N
ci+z+0A39vNO++b5Se+tk0apZlPlgb2NK3LxxR+LHevFed9GRzdvbGk/F7Se3CyP
cxgswdazC6fwGjhX1mOYsG1oIU0V6X7f0FnaqWETrwf1M9yGEO78xzDfgozIazP0
s0fQeR9KXsZcuaotO3TIRxRRAoGAMFIDsLRvDKm1rkL0B0czm/hwwDMu/KDyr5/R
2M2OS1TB4PjmCgeUFOmyq3A63OWuStxtJboribOK8Qd1dXvWj/3NZtVY/z/j1P1E
Ceq6We0MOZa0Ae4kyi+p/kbAKPgv+VwSoc6cKailRHZPH7quLoJSIt0IgbfRnXC6
ygtcLNMCgYBwiPw2mTYvXDrAcO17NhK/r7IL7BEdFdx/w8vNJQp+Ub4OO3Iw6ARI
vXxu6A+Qp50jra3UUtnI+hIirMS+XEeWqJghK1js3ZR6wA/ZkYZw5X1RYuPexb/4
6befxmnEuGSbsgvGqYYTf5Z0vgsw4tAHfNS7TqSulYH06CjeG1F8DQ<span class="token operator">==</span>
-----END RSA PRIVATE KEY-----
private_key_type    rsa
serial_number       59:0b:af:a4:ca:40:db:29:b7:e8:4a:22:63:27:f7:3a:ce:54:78:8a
</code></pre></div><p>Vault 现在使用 <code>example-dot-com</code> 角色配置生成一组新凭据。在这里，我们看到动态生成的私钥和证书。</p> <p>使用 ACL，可以限制使用 <code>pki</code> 后端，以便可信操作者可以管理角色定义，并且用户和应用程序都受限于这个凭据，仅允许读取。</p> <p>如果在任何时候遇到困难，只需运行 <code>vault path-help pki</code> 或使用子路径输出帮助。</p> <h3 id="setting-up-intermediate-ca"><a href="#setting-up-intermediate-ca" aria-hidden="true" class="header-anchor">#</a> Setting Up Intermediate CA</h3> <p>在快速入门指南中，证书直接从根证书颁发机构颁发。 如示例中所述，这不是推荐的做法。本指南以先前指南的根证书颁发机构为基础，使用根权限创建中间权限以签署中间证书。</p> <h4 id="mount-the-backend-2"><a href="#mount-the-backend-2" aria-hidden="true" class="header-anchor">#</a> Mount the backend</h4> <p>要将另一个证书颁发机构添加到 Vault 实例，我们必须将其安装在其他路径上。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ vault secrets <span class="token function">enable</span> -path<span class="token operator">=</span>pki_int pki
Successfully mounted <span class="token string">'pki'</span> at <span class="token string">'pki_int'</span><span class="token operator">!</span>
</code></pre></div><h4 id="configure-an-intermediate-ca"><a href="#configure-an-intermediate-ca" aria-hidden="true" class="header-anchor">#</a> Configure an Intermediate CA</h4> <div class="language-bash extra-class"><pre class="language-bash"><code>$ vault secrets tune -max-lease-ttl<span class="token operator">=</span>43800h pki_int
Successfully tuned <span class="token function">mount</span> <span class="token string">'pki_int'</span><span class="token operator">!</span>
</code></pre></div><p>这里将最大 TTL 设置为5年。 此值应小于或等于根证书颁发机构。</p> <p>现在，我们生成中间证书签名请求</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ vault <span class="token function">write</span> pki_int/intermediate/generate/internal common_name<span class="token operator">=</span><span class="token string">&quot;myvault.com Intermediate Authority&quot;</span> ttl<span class="token operator">=</span>43800h
Key Value
csr -----BEGIN CERTIFICATE REQUEST-----
MIICsjCCAZoCAQAwLTErMCkGA1UEAxMibXl2YXVsdC5jb20gSW50ZXJtZWRpYXRl
IEF1dGhvcml0eTCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBAJU1Qh8l
BW16WHAu34Fy92FnSy4219WVlKw1xwpKxjd95xH6WcxXozOs6oHFQ9c592bz51F8
KK3FFJYraUrGONI5Cz9qHbzC1mFCmjnXVXCoeNKIzEBG0Y+ehH7MQ1SvDCyvaJPX
ItFXaGf6zENiGsApw3Y3lFr0MjPzZDBH1p4Nq3aA6L2BaxvO5vczdQl5tE2ud/zs
GIdCWnl1ThDEeiX1Ppduos/dx3gaZa9ly3iCuDMKIL9yK5XTBTgKB6ALPApekLQB
kcUFbOuMzjrDSBe9ytu65yICYp26iAPPA8aKTj5cUgscgzEvQS66rSAVG/unrWxb
wbl8b7eQztCmp60CAwEAAaBAMD4GCSqGSIb3DQEJDjExMC8wLQYDVR0RBCYwJIIi
bXl2YXVsdC5jb20gSW50ZXJtZWRpYXRlIEF1dGhvcml0eTANBgkqhkiG9w0BAQsF
AAOCAQEAZA9A1QvTdAd45+Ay55FmKNWnis1zLjbmWNJURUoDei6i6SCJg0YGX1cZ
WkD0ibxPYihSsKRaIUwC2bE8cxZM57OSs7ISUmyPQAT2IHTHvuGK72qlFRBlFOzg
SHEG7gfyKdrALphyF8wM3u4gXhcnY3CdltjabL3YakZqd3Ey4870/0XXeo5c4k7w
/+n9M4xED4TnXYCGfLAlu5WWKSeCvu9mHXnJcLo1MiYjX7KGey/xYYbfxHSPm4ul
tI6Vf59zDRscfNmq37fERD3TiKP0QZNGTSRvnrxrx2RUQGXFywM8l4doG8nS5BxU
2jP20cdv0lJFvHr9663/8B/+F5L6Yw<span class="token operator">==</span>
-----END CERTIFICATE REQUEST-----
</code></pre></div><p>从中间权限获取签名请求，并使用另一个证书颁发机构对其进行签名，在本例中为第一个示例中生成的根证书颁发机构。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ vault <span class="token function">write</span> pki/root/sign-intermediate csr<span class="token operator">=</span>@pki_int.csr format<span class="token operator">=</span>pem_bundle ttl<span class="token operator">=</span>43800h
Key             Value
certificate     -----BEGIN CERTIFICATE-----
MIIDZTCCAk2gAwIBAgIUENxQD7KIJi1zE/jEiYqAG1VC4NwwDQYJKoZIhvcNAQEL
BQAwFjEUMBIGA1UEAxMLbXl2YXVsdC5jb20wHhcNMTcxMTI4MTcwNzIzWhcNMjIx
MTI3MTcwNzUzWjAtMSswKQYDVQQDEyJteXZhdWx0LmNvbSBJbnRlcm1lZGlhdGUg
QXV0aG9yaXR5MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA5seNV4Yd
uCMX0POUUuSzCBiR3Cyf9b9tGsCX7UfvZmjPs+Fl/X+Ovq6UtHM9RuTGlyfFrCWy
pflO7mc0H8PBzlvhv1WQet5aRyUOXkG6iYmooG9iobIY8z/TZCaCF605pgygfOaS
DIlwOdJkfiXxGpQ00pfIwe/Y2OK2I5e36u0E2EA6kXvcfexLjQGFPbod+H0R29Ro
/GwOJ6MpSHqB77mF025x1y08EtqT1z1kFCiDzFSkzNZEZYWljhDS6ZRY9ctzKufm
5CkUwmvCVRI2CivDJvmfhXyv0DRoq4IhYdJHo179RSObq3BY9f9LQ0balNLiM0Ft
O8f0urTqUAbySwIDAQABo4GTMIGQMA4GA1UdDwEB/wQEAwIBBjAPBgNVHRMBAf8E
BTADAQH/MB0GA1UdDgQWBBSQgTfcMrKYzyckP6t/0iVQkl0ZBDAfBgNVHSMEGDAW
gBRccsCARqs3wQDjW7JMNXS6pWlFSDAtBgNVHREEJjAkgiJteXZhdWx0LmNvbSBJ
bnRlcm1lZGlhdGUgQXV0aG9yaXR5MA0GCSqGSIb3DQEBCwUAA4IBAQABNg2HxccY
DwRpsJ+sxA0BgDyF+tYtOlXViVNv6Z+nOU0nNhQSCjfzjYWmBg25nfKaFhQSC3b7
fIW+e7it/FLVrCgaqdysoxljqhR0gXMAy8S/ubmskPWjJiKauJB5bfB59Uf2GP6j
zimZDu6WjWvvgkKcJqJEbOOS9DWBvCTdmmml1NMXZtcytpod2Y7mxninqNRx3qpx
Pst4vgAbyM/3zLSzkyUD+MXIyRXwxktFlyEYBHvMd9OoHzLO6WLxk22FyQQ+w4by
NfXJY4r5pj6a4lJ6pPuqyfBhidYMTdY3AI7w/QRGk4qQv1iDmnZspk2AxdbR5Lwe
YmChIML/f++S
-----END CERTIFICATE-----
expiration      1669568873
issuing_ca      -----BEGIN CERTIFICATE-----
MIIDNTCCAh2gAwIBAgIUdR44qhhyh3CZjnCtflGKQlTI8NswDQYJKoZIhvcNAQEL
BQAwFjEUMBIGA1UEAxMLbXl2YXVsdC5jb20wHhcNMTcxMTI4MTYxODA2WhcNMjcx
MTI2MTYxODM1WjAWMRQwEgYDVQQDEwtteXZhdWx0LmNvbTCCASIwDQYJKoZIhvcN
AQEBBQADggEPADCCAQoCggEBANTPnQ2CUkuLrYT4V6/IIK/gWFZXFG4lWTmgM5Zh
PDquMhLEikZCbZKbupouBI8MOr5i8tycENaTnSs9dBwVEOWAHbLkliVgvCKgLi0F
PfPM87FnBoKVctO2ip8AdmYcAt/wc096dWBG6eKLVP5xsAe7NcYDtF/inHgEZ22q
ZjGVEyC6WntIASgULoHGgHakPp1AHLhGm8nL5YbusWY7RgZIlNeGWLVoneG0pxdV
7W1SPO67dsQyq58mTxMIGVUj5YE1q7/C6OhCTnAHc+sRm0oUehPfO8kY4NHpCJGv
nDRdJi6k6ewk94c0KK2tUUM/TN6ZSRfx6ccgfPH8zNcVPVcCAwEAAaN7MHkwDgYD
VR0PAQH/BAQDAgEGMA8GA1UdEwEB/wQFMAMBAf8wHQYDVR0OBBYEFFxywIBGqzfB
AONbskw1dLqlaUVIMB8GA1UdIwQYMBaAFFxywIBGqzfBAONbskw1dLqlaUVIMBYG
A1UdEQQPMA2CC215dmF1bHQuY29tMA0GCSqGSIb3DQEBCwUAA4IBAQBgvsgpBuVR
iKVdXXpFyoQLImuoaHZgaj5tuUDqnMoxOA1XWW6SVlZmGfDQ7+u5NBkp2cGSDRGm
ARHJTeURvdZIwdFdGkNqfAZjutRjjQOnXgS65ujZd7AnlZq1v0ZOZqVVk9YEOhOe
Rh2MjnHGNuiLBib1YNQHNuRef1mPwIE2Gm/Tz/z3JPHtkKNIKbn60zHrIIM/OT2Z
HYjcMUcqXtKGYfNjVspJm3lSDUoyJdaq80Afmy2Ez1Vt9crGG3Dj8mgs59lEhEyo
MDVhOP116M5HJfQlRPVd29qS8pFrjBvXKjJSnJNG1UFdrWBJRJ3QrBxUQALKrJlR
g5lvTeymHjS/
-----END CERTIFICATE-----
serial_number   10:dc:50:0f:b2:88:26:2d:73:13:f8:c4:89:8a:80:1b:55:42:e0:dc
</code></pre></div><p>现在将中间证书颁发机构签名证书设置为根签名证书。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ vault <span class="token function">write</span> pki_int/intermediate/set-signed certificate<span class="token operator">=</span>@signed_certificate.pem
Success<span class="token operator">!</span> Data written to: pki_int/intermediate/set-signed
</code></pre></div><p>现在配置好了中间证书颁发机构，并且可以颁发证书。</p> <h4 id="set-url-configuration-2"><a href="#set-url-configuration-2" aria-hidden="true" class="header-anchor">#</a> Set URL configuration</h4> <p>生成的证书可以具有 CRL 位置和颁发证书编码的位置。 这些值必须手动设置，但可以随时更改。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ vault <span class="token function">write</span> pki_int/config/urls issuing_certificates<span class="token operator">=</span><span class="token string">&quot;http://127.0.0.1:8200/v1/pki_int/ca&quot;</span> crl_distribution_points<span class="token operator">=</span><span class="token string">&quot;http://127.0.0.1:8200/v1/pki_int/crl&quot;</span>
Success<span class="token operator">!</span> Data written to: pki_int/ca/urls
</code></pre></div><h4 id="configure-a-role-2"><a href="#configure-a-role-2" aria-hidden="true" class="header-anchor">#</a> Configure a role</h4> <p>下一步是配置 <code>role</code>。 <code>role</code> 是映射到用于生成这些凭据的策略的逻辑名称。 例如，我们创建一个 “example-dot-com” 的 <code>role</code>：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ vault <span class="token function">write</span> pki_int/roles/example-dot-com \
    allowed_domains<span class="token operator">=</span>example.com \
    allow_subdomains<span class="token operator">=</span>true max_ttl<span class="token operator">=</span>72h
Success<span class="token operator">!</span> Data written to: pki_int/roles/example-dot-com
</code></pre></div><h4 id="issue-certificates-2"><a href="#issue-certificates-2" aria-hidden="true" class="header-anchor">#</a> Issue Certificates</h4> <p>通过写入 <code>roles/example-dot-com</code> 路径，我们定义了 <code>example-dot-com</code> 角色。 要生成新证书，我们只需使用该 <code>role</code> 名称写入 <code>issue</code> 端点：Vault 现已配置好，可以创建和管理证书。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ vault <span class="token function">write</span> pki_int/issue/example-dot-com \
    common_name<span class="token operator">=</span>blah.example.com
Key                 Value
---                 -----
certificate         -----BEGIN CERTIFICATE-----
MIIDbDCCAlSgAwIBAgIUPiAyxq+nIE6xlWf7hrzLkPQxtvMwDQYJKoZIhvcNAQEL
BQAwMzExMC8GA1UEAxMoVmF1bHQgVGVzdGluZyBJbnRlcm1lZGlhdGUgU3ViIEF1
dGhvcml0eTAeFw0xNjA5MjcwMDA5MTNaFw0xNjA5MjcwMTA5NDNaMBsxGTAXBgNV
BAMTEGJsYWguZXhhbXBsZS5jb20wggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEK
AoIBAQDJAYB04IVdmSC/TimaA6BbXlvgBTZHL5wBUTmO4iHhenL0eDEXVe2Fd7Yq
75LiBJmcC96hKbqh5rwS8KwN9ElZI52/mSMC+IvoNlYHAf7shwfsjrVx3q7/bTFg
lz6wECn1ugysxynmMvgQD/pliRkxTQ7RMh4Qlh75YG3R9BHy9ZddklZp0aNaitts
0uufHnN1UER/wxBCZdWTUu34KDL9I6yE7Br0slKKHPdEsGlFcMkbZhvjslZ7DGvO
974S0qtOdKiawJZbpNPg0foGZ3AxesDUlkHmmgzUNes/sjknDYTHEfeXM6Uap0j6
XvyhCxqdeahb/Vtibg0z9I0IusJbAgMBAAGjgY8wgYwwDgYDVR0PAQH/BAQDAgOo
MB0GA1UdJQQWMBQGCCsGAQUFBwMBBggrBgEFBQcDAjAdBgNVHQ4EFgQU/5oy0rL7
TT0wX7KZK7qcXqgayNwwHwYDVR0jBBgwFoAUgM37P8oXmA972ztLfw+b1eIY5now
GwYDVR0RBBQwEoIQYmxhaC5leGFtcGxlLmNvbTANBgkqhkiG9w0BAQsFAAOCAQEA
CT2vI6/taeLTw6ZulUhLXEXYXWZu1gF8n2COjZzbZXmHxQAoZ3GtnSNwacPHAyIj
f3cA9Moo552y39LUtWk+wgFtQokWGK7LXglLaveNUBowOHq/xk0waiIinJcgTG53
Z/qnbJnTjAOG7JwVJplWUIiS1avCksrHt7heE2EGRGJALqyLZ119+PW6ogtCLUv1
X8RCTw/UkIF/LT+sLF0bXWy4Hn38Gjwj1MVv1l76cEGOVSHyrYkN+6AMnAP58L5+
IWE9tN3oac4x7jhbuNpfxazIJ8Q6l/Up5U5Evfbh6N1DI0/gFCP20fMBkHwkuLfZ
2ekZoSeCgFRDlHGkr7Vv9w<span class="token operator">==</span>
-----END CERTIFICATE-----
issuing_ca          -----BEGIN CERTIFICATE-----
MIIDijCCAnKgAwIBAgIUB28DoGwgGFKL7fbOu9S4FalHLn0wDQYJKoZIhvcNAQEL
BQAwLzEtMCsGA1UEAxMkVmF1bHQgVGVzdGluZyBJbnRlcm1lZGlhdGUgQXV0aG9y
aXR5MB4XDTE2MDkyNzAwMDgyMVoXDTI2MDkxNjE2MDg1MVowMzExMC8GA1UEAxMo
VmF1bHQgVGVzdGluZyBJbnRlcm1lZGlhdGUgU3ViIEF1dGhvcml0eTCCASIwDQYJ
KoZIhvcNAQEBBQADggEPADCCAQoCggEBAOSCiSij4wy1wiMwvZt+rtU3IaO6ZTn9
LfIPuGsR5/QSJk37pCZQco1LgoE/rTl+/xu3bDovyHDmgObghC6rzVOX2Tpi7kD+
DOZpqxOsaS8ebYgxB/XJTSxyEJuSAcpSNLqqAiZivuQXdaD0N7H3Or0awwmKE9mD
I0g8CF4fPDmuuOG0ASn9fMqXVVt5tXtEqZ9yJYfNOXx3FOPjRVOZf+kvSc31wCKe
i/KmR0AQOmToKMzq988nLqFPTi9KZB8sEU20cGFeTQFol+m3FTcIru94EPD+nLUn
xtlLELVspYb/PP3VpvRj9b+DY8FGJ5nfSJl7Rkje+CD4VxJpSadin3kCAwEAAaOB
mTCBljAOBgNVHQ8BAf8EBAMCAQYwDwYDVR0TAQH/BAUwAwEB/zAdBgNVHQ4EFgQU
gM37P8oXmA972ztLfw+b1eIY5nowHwYDVR0jBBgwFoAUj4YAIxRwrBy0QMRKLnD0
kVidIuYwMwYDVR0RBCwwKoIoVmF1bHQgVGVzdGluZyBJbnRlcm1lZGlhdGUgU3Vi
IEF1dGhvcml0eTANBgkqhkiG9w0BAQsFAAOCAQEAA4buJuPNJvA1kiATLw1dVU2J
HPubk2Kp26Mg+GwLn7Vz45Ub133JCYfF3/zXLFZZ5Yub9gWTtjScrvNfQTAbNGdQ
BdnUlMmIRmfB7bfckhryR2R9byumeHATgNKZF7h8liNHI7X8tTzZGs6wPdXOLlzR
TlM3m1RNK8pbSPOkfPb06w9cBRlD8OAbNtJmuypXA6tYyiiMYBhP0QLAO3i4m1ns
aAjAgEjtkB1rQxW5DxoTArZ0asiIdmIcIGmsVxfDQIjFlRxAkafMs74v+5U5gbBX
wsOledU0fLl8KLq8W3OXqJwhGLK65fscrP0/omPAcFgzXf+L4VUADM4XhW6Xyg<span class="token operator">==</span>
-----END CERTIFICATE-----
ca_chain            <span class="token punctuation">[</span>-----BEGIN CERTIFICATE-----
MIIDijCCAnKgAwIBAgIUB28DoGwgGFKL7fbOu9S4FalHLn0wDQYJKoZIhvcNAQEL
BQAwLzEtMCsGA1UEAxMkVmF1bHQgVGVzdGluZyBJbnRlcm1lZGlhdGUgQXV0aG9y
aXR5MB4XDTE2MDkyNzAwMDgyMVoXDTI2MDkxNjE2MDg1MVowMzExMC8GA1UEAxMo
VmF1bHQgVGVzdGluZyBJbnRlcm1lZGlhdGUgU3ViIEF1dGhvcml0eTCCASIwDQYJ
KoZIhvcNAQEBBQADggEPADCCAQoCggEBAOSCiSij4wy1wiMwvZt+rtU3IaO6ZTn9
LfIPuGsR5/QSJk37pCZQco1LgoE/rTl+/xu3bDovyHDmgObghC6rzVOX2Tpi7kD+
DOZpqxOsaS8ebYgxB/XJTSxyEJuSAcpSNLqqAiZivuQXdaD0N7H3Or0awwmKE9mD
I0g8CF4fPDmuuOG0ASn9fMqXVVt5tXtEqZ9yJYfNOXx3FOPjRVOZf+kvSc31wCKe
i/KmR0AQOmToKMzq988nLqFPTi9KZB8sEU20cGFeTQFol+m3FTcIru94EPD+nLUn
xtlLELVspYb/PP3VpvRj9b+DY8FGJ5nfSJl7Rkje+CD4VxJpSadin3kCAwEAAaOB
mTCBljAOBgNVHQ8BAf8EBAMCAQYwDwYDVR0TAQH/BAUwAwEB/zAdBgNVHQ4EFgQU
gM37P8oXmA972ztLfw+b1eIY5nowHwYDVR0jBBgwFoAUj4YAIxRwrBy0QMRKLnD0
kVidIuYwMwYDVR0RBCwwKoIoVmF1bHQgVGVzdGluZyBJbnRlcm1lZGlhdGUgU3Vi
IEF1dGhvcml0eTANBgkqhkiG9w0BAQsFAAOCAQEAA4buJuPNJvA1kiATLw1dVU2J
HPubk2Kp26Mg+GwLn7Vz45Ub133JCYfF3/zXLFZZ5Yub9gWTtjScrvNfQTAbNGdQ
BdnUlMmIRmfB7bfckhryR2R9byumeHATgNKZF7h8liNHI7X8tTzZGs6wPdXOLlzR
TlM3m1RNK8pbSPOkfPb06w9cBRlD8OAbNtJmuypXA6tYyiiMYBhP0QLAO3i4m1ns
aAjAgEjtkB1rQxW5DxoTArZ0asiIdmIcIGmsVxfDQIjFlRxAkafMs74v+5U5gbBX
wsOledU0fLl8KLq8W3OXqJwhGLK65fscrP0/omPAcFgzXf+L4VUADM4XhW6Xyg<span class="token operator">==</span>
-----END CERTIFICATE-----<span class="token punctuation">]</span>
private_key         -----BEGIN RSA PRIVATE KEY-----
MIIEpgIBAAKCAQEAyQGAdOCFXZkgv04pmgOgW15b4AU2Ry+cAVE5juIh4Xpy9Hgx
F1XthXe2Ku+S4gSZnAveoSm6oea8EvCsDfRJWSOdv5kjAviL6DZWBwH+7IcH7I61
cd6u/20xYJc+sBAp9boMrMcp5jL4EA/6ZYkZMU0O0TIeEJYe+WBt0fQR8vWXXZJW
adGjWorbbNLrnx5zdVBEf8MQQmXVk1Lt+Cgy/SOshOwa9LJSihz3RLBpRXDJG2Yb
47JWewxrzve+EtKrTnSomsCWW6TT4NH6BmdwMXrA1JZB5poM1DXrP7I5Jw2ExxH3
lzOlGqdI+l78oQsanXmoW/1bYm4NM/SNCLrCWwIDAQABAoIBAQCCbHMJY1Wl8eIJ
v5HG2WuHXaaHqVoavo2fXTDXwWryfx1v+zz/Q0YnQBH3shPAi/OQCTOfpw/uVWTb
dUZul3+wUyfcVmUdXGCLgBY53dWna8Z8e+zHwhISsqtDXV/TpelUBDCNO324XIIR
Cg0TLO4nyzQ+ESLo6D+Y2DTp8lBjMEkmKTd8CLXR2ycEoVykN98qPZm8keiLGO91
I8K7aRd8uOyQ6HUfJRlzFHSuwaLReErxGTEPI4t/wVqh2nP2gGBsn3apiJ0ul6Jz
NlYO5PqiwpeDk4ibhQBpicnm1jnEcynH/WtGuKgMNB0M4SBRBsEguO7WoKx3o+qZ
iVIaPWDhAoGBAO05UBvyJpAcz/ZNQlaF0EAOhoxNQ3h6+6ZYUE52PgZ/DHftyJPI
Y+JJNclY91wn91Yk3ROrDi8gqhzA+2Lelxo1kuZDu+m+bpzhVUdJia7tZDNzRIhI
24eP2GdochooOZ0qjvrik4kuX43amBhQ4RHsBjmX5CnUlL5ZULs8v2xnAoGBANjq
VLAwiIIqJZEC6BuBvVYKaRWkBCAXvQ3j/OqxHRYu3P68PZ58Q7HrhrCuyQHTph2v
fzfmEMPbSCrFIrrMRmjUG8wopL7GjZjFl8HOBHFwzFiz+CT5DEC+IJIRkp4HM8F/
PAzjB2wCdRdSjLTD5ph0/xQIg5xfln7D+wqU0QHtAoGBAKkLF0/ivaIiNftw0J3x
WxXag/yErlizYpIGCqvuzII6lLr9YdoViT/eJYrmb9Zm0HS9biCu2zuwDijRSBIL
RieyF40opUaKoi3+0JMtDwTtO2MCd8qaCH3QfkgqAG0tTuj1Q8/6F2JA/myKYamq
MMhhpYny9+7rAlemM8ZJIqtvAoGBAKOI3zpKDNCdd98A4v7B7H2usZUIJ7gOTZDo
XqiNyRENWb2PK6GNq/e6SrxvuclvyKA+zFnXULJoYtsj7tAH69lieGaOCc5uoRgZ
eBU7/euMj/McE6vEO3GgJawaJYCQi3uJMjvA+bp7i81+hehOfU5ZfmmbFaZSBoMh
u+U5Vu3tAoGBANnBIbHfD3E7rqnqdpH1oRRHLA1VdghzEKgyUTPHNDzPJG87RY3c
rRqeXepblud3qFjD60xS9BzcBijOvZ4+KHk6VIMpkyqoeNVFCJbBVCw+JGMp88+v
e9t+2iwryh5+rnq+pg6anmgwHldptJc1XEFZA2UUQ89RP7kOGQF6IkIS
-----END RSA PRIVATE KEY-----
private_key_type    rsa
serial_number       3e:20:32:c6:af:a7:20:4e:b1:95:67:fb:86:bc:cb:90:f4:31:b6:f3
</code></pre></div><p>Vault 现在使用 <code>example-dot-com</code> 角色配置生成一组新凭据。 在这里，我们看到动态生成的私钥和证书。 还将返回颁发CA证书和CA信任链。 CA Chain 返回信任链中的所有中间权限。
不包括根权限，因为底层操作系统通常会信任它。</p> <h3 id="api"><a href="#api" aria-hidden="true" class="header-anchor">#</a> API</h3> <p>PKI secrets 引擎有完整的 HTTP API，查看更多 <a href>PKI secrets engine API</a> 详情。</p></div> <div class="page-edit"><div class="edit-link"><a href="https://github.com/shipengqi/vault-docs-Zh-CN/edit/master/docs/document/secrets-engines.md" target="_blank" rel="noopener noreferrer">错别字纠正</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/vault-docs-Zh-CN/document/vault-agent.html" class="prev">
          Vault 代理
        </a></span> <span class="next"><a href="/vault-docs-Zh-CN/document/auth-methods.html">
          Auth 方法
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/vault-docs-Zh-CN/assets/js/14.92bdbbbe.js" defer></script><script src="/vault-docs-Zh-CN/assets/js/app.341f2fd2.js" defer></script>
  </body>
</html>
